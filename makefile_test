VES3D_DIR = $(shell pwd)

# include rules and flag for compiler/host
VES3D_MKDIR ?= ${VES3D_DIR}/makefile.in.files
include ${VES3D_MKDIR}/makefile.in

CXXFLAGS += -I./SCTL/include

ifeq ($(shell uname -s),Darwin)
	CXXFLAGS += -g -rdynamic -Wl,-no_pie # for stack trace (on Mac)
else
	CXXFLAGS += -g -rdynamic # for stack trace
endif

CXXFLAGS += -Wall -Wfloat-conversion  -O3 -march=native -DNDEBUG -DSCTL_GLOBAL_MEM_BUFF=0  -DSCTL_PROFILE=5 -DSCTL_VERBOSE  -DSCTL_QUAD_T=__float128  -lblas -DSCTL_HAVE_BLAS  -llapack -DSCTL_HAVE_LAPACK

# targets of install
VES3D_BINS = pulled_vesicle

all: install

lib:
	${MAKE} -C lib

install: $(addprefix ${VES3D_BINDIR}/,${VES3D_BINS})

test:
	${MAKE} -C  ${VES3D_TSTDIR}

check:
	${MAKE} -C ${VES3D_TSTDIR} check

doc: ${MAKE_DEP}
	${DOX} ${VES3D_DOCDIR}/Doxyfile

tag: ${MAKE_DEP}
	${TAGS} ${VES3D_SRCDIR}/*.cc  ${VES3D_INCDIR}/*.h ${VES3D_TSTDIR}/*.cc ${VES3D_TSTDIR}/*.h

all-tag: ${MAKE_DEP}
	${TAGS} ${VES3D_SRCDIR}/*  ${VES3D_INCDIR}/* ${VES3D_TSTDIR}/*

${VES3D_BINDIR}/%: ${VES3D_SRCDIR}/%.o ${MAKE_DEP} lib
	-@${MKDIR} $(dir $@)
	${CXX} ${CXXFLAGS} ${CPPFLAGS} ${LDFLAGS} $< ${LDLIBS} -o $@
	${CXX} -MM -MT ${VES3D_SRCDIR}/$*.o ${CXXFLAGS} ${CPPFLAGS} -c -o ${VES3D_SRCDIR}/$*.d ${VES3D_SRCDIR}/$*.cc

clean:
	${MAKE} -C ${VES3D_LIBDIR} clean
	-${RM} *.o ${VES3D_SRCDIR}/*.o ${VES3D_SRCDIR}/*.d
	-${RM} -r ${VES3D_DOCDIR}/latex ${VES3D_DOCDIR}/html TAGS
	-${RM} *.${VES3D_CHKEXT} ${VES3D_EXPRDIR}/*.${VES3D_CHKEXT} *.vtp *.pvtp

distclean:
	${MAKE} clean
	${MAKE} -C ${VES3D_LIBDIR} distclean
	${MAKE} -C ${VES3D_TSTDIR} distclean
	-${RM} $(addprefix ${VES3D_BINDIR}/,${VES3D_BINS})

# include dependency file for templates (generated when making bin files)
-include $(addprefix ${VES3D_SRCDIR}/, $(addsuffix .d, ${VES3D_BINS}))

help:
	@echo "    Useful compilation flags are:"
	@echo "        VES3D_DEBUG      [yes|no] affects only compiler flags (not printing verbosity)"
	@echo "        VES3D_PROFILE    [yes|no] turns profiling macros on"
	@echo "        VES3D_VERBOSE    [1|2|3]  1=most verbose, 2=normal, 3=quiet"
	@echo "        VES3D_TESTING    [yes|no] equal to DEBUG and PROFILE"
	@echo "        VES3D_VERSION    default to 'hg id -n' (local to repo) can be set as argument if hg is not working on the node"

.PHONY: all lib install test check doc tags all-tags clean distclean
.SECONDARY:
